# 수학 방정식 그래프 햅틱 피드백 시스템 사용 가이드

## 🎯 시스템 개요

이 시스템은 **스테레오 비전**과 **햅틱 피드백**을 결합하여 테이블 위에 수학 그래프를 가상으로 투사하고, 손가락으로 그래프를 따라가면 진동으로 피드백을 제공합니다.

### 주요 특징
- ✅ **단일 손 추적** (한 손만 사용)
- ✅ **수학 방정식 입력** → 테이블 위 그래프로 변환
- ✅ **실시간 좌표평면 매핑** (카메라 인식 범위)
- ✅ **햅틱 피드백** (그래프 접촉 시 진동)
- ✅ **실시간 방정식 변경** 가능

---

## 📐 좌표계 이해

### 테이블 좌표평면
```
카메라 인식 범위 (기본값):
┌─────────────────────────────────┐
│  X축: -300mm ~ +300mm (좌우)    │
│  Z축:  200mm ~ 800mm  (깊이)    │
│  Y축:  200mm (테이블 높이)      │
└─────────────────────────────────┘

좌표계:
- X축: 좌(-)에서 우(+)
- Y축: 위(-)에서 아래(+) ← 중요!
- Z축: 카메라에서 멀어지는 방향(+)
```

### 방정식 → 3D 그래프 변환
```python
사용자 입력: y = f(x)
         ↓
3D 좌표 변환: (x, TABLE_HEIGHT, z)
         ↓
z = z_offset + f(x)
```

**예시:**
- 방정식: `y = x²/100`
- x = -100일 때: `(x=-100, y=200, z=400+100=500)`
- x = 0일 때: `(x=0, y=200, z=400+0=400)`
- x = 100일 때: `(x=100, y=200, z=400+100=500)`

→ U자 형태의 포물선이 테이블 위에 생성됨

---

## 🚀 실행 방법

### 1. 사전 준비
```bash
# 캘리브레이션 (최초 1회만)
python examples/calibrate_cameras.py

# 체스보드 패턴으로 양쪽 카메라에서 20장 촬영
# → data/stereo_calibration.pkl 생성
```

### 2. 시스템 실행
```bash
python main.py
```

### 3. 방정식 선택
```
사용 가능한 방정식:
  1: y = x^2 / 100          # 포물선
  2: y = sin(x/50) * 100    # 사인파
  3: y = abs(x) / 2         # V자 형태
  4: y = -x^2 / 100 + 200   # 역포물선
  5: y = cos(x/30) * 80     # 코사인파
  0: 방정식 없음 (테스트 모드)

방정식을 선택하세요 (0-5): 1
```

### 4. 손 추적 시작
- 한 손을 양쪽 카메라에 보이도록 위치
- 검지손가락을 테이블 위로 내림 (y ≥ 200mm)
- 그래프 선을 따라 손가락 이동

### 5. 햅틱 피드백
- 검지손가락이 그래프 선에 닿으면 **진동 발생**
- 그래프에서 벗어나면 **진동 정지**

---

## ⌨️ 키보드 단축키

실행 중 키보드로 실시간 제어 가능:

| 키 | 기능 |
|---|---|
| **1** | y = x²/100 (포물선) |
| **2** | y = sin(x/50) * 100 (사인파) |
| **3** | y = abs(x) / 2 (V자) |
| **4** | y = -x²/100 + 200 (역포물선) |
| **5** | y = cos(x/30) * 80 (코사인파) |
| **0** | 그래프 제거 |
| **ESC** | 프로그램 종료 |

---

## 🖥️ 화면 정보 설명

### 왼쪽 카메라 화면
```
┌─────────────────────────────────┐
│ FPS: 28.3                        │
│ Equation: y = x^2 / 100          │ ← 현재 방정식
│ Table Height: 200.0 mm           │
│ Motor: VIBRATING!                │ ← 진동 상태
│                                   │
│ Index Finger Tip:                │
│   Pos: (45.2, 205.3, 432.1)     │ ← 3D 좌표 (mm)
│   Graph Dist: 8.5 mm             │ ← 그래프까지 거리
│   Status: TOUCHING GRAPH!        │ ← 접촉 상태
│                                   │
│   [손 랜드마크 표시]             │
└─────────────────────────────────┘
```

### 상태 표시
- **ABOVE TABLE**: 손가락이 테이블 위 (y < 200mm)
- **ON TABLE**: 손가락이 테이블에 닿음 (y ≥ 200mm)
- **TOUCHING GRAPH!**: 그래프에 접촉 중
- **VIBRATING!**: 진동모터 작동 중

---

## 🔧 설정 커스터마이징

### `main.py` 파일 수정

#### 1. 테이블 높이 조정
```python
TABLE_HEIGHT_THRESHOLD = 200.0  # mm
# 값을 크게: 손을 더 내려야 "테이블 접촉" 인식
# 값을 작게: 손을 덜 내려도 "테이블 접촉" 인식
```

#### 2. 좌표평면 범위 조정
```python
def get_coordinate_bounds(stereo_calib, table_height=200.0):
    x_min, x_max = -300, 300  # X축 범위 (좌우)
    z_min, z_max = 200, 800   # Z축 범위 (깊이)
    return x_min, x_max, z_min, z_max
```

#### 3. 그래프 두께 조정
```python
virtual_graph = VirtualGraph(thickness=30.0)  # mm
# 값을 크게: 그래프 감지 범위 넓어짐 (쉬움)
# 값을 작게: 정밀한 접촉만 감지 (어려움)
```

#### 4. 진동 강도 조정
```python
motor_controller.start_all(intensity=80.0)  # 0~100%
# 50.0: 약한 진동
# 80.0: 중간 진동 (기본값)
# 100.0: 최대 진동
```

#### 5. 커스텀 방정식 추가
```python
equations = {
    '1': ('y = x^2 / 100', lambda x: (x**2) / 100),
    '2': ('y = sin(x/50) * 100', lambda x: np.sin(x/50) * 100),
    # 새로운 방정식 추가
    '6': ('y = x^3 / 10000', lambda x: (x**3) / 10000),
    '7': ('y = log(abs(x)+1) * 50', lambda x: np.log(abs(x)+1) * 50),
}
```

### `config/config.yaml` 파일 수정

#### 카메라 인덱스 변경
```yaml
camera:
  left_camera_index: 0   # 왼쪽 카메라
  right_camera_index: 1  # 오른쪽 카메라
```

#### GPIO 핀 변경
```yaml
motors:
  vibration_motors:
    hand_left:
      pin: 18  # GPIO 핀 번호
```

#### 손 추적 민감도 조정
```yaml
hand_tracking:
  min_detection_confidence: 0.5  # 0.3~0.9
  min_tracking_confidence: 0.5   # 0.3~0.9
  # 값을 낮추면: 감지 쉬워짐 (오검출 증가)
  # 값을 높이면: 정확도 증가 (감지 어려워짐)
```

---

## 🧪 시나리오별 사용 예시

### 시나리오 1: 포물선 그래프 학습
```bash
1. python main.py 실행
2. 방정식 "1" 선택 (y = x²/100)
3. 손을 중앙(x=0)에서 시작
4. 천천히 좌우로 이동하며 포물선 형태 체험
5. 그래프 선을 따라가면 진동 피드백 느낌
```

### 시나리오 2: 사인파 그래프 체험
```bash
1. 방정식 "2" 선택 (y = sin(x/50) * 100)
2. 손가락을 왼쪽 끝(-300mm)에서 시작
3. 천천히 오른쪽으로 이동
4. 파동이 반복되는 패턴 인식
```

### 시나리오 3: 실시간 방정식 비교
```bash
1. 방정식 "1" 선택 (포물선)
2. 그래프 형태를 손가락으로 확인
3. 키보드 "2" 누름 (사인파로 변경)
4. 같은 경로에서 다른 패턴 체험
```

### 시나리오 4: 정밀도 테스트
```bash
1. main.py에서 thickness=10.0으로 변경 (얇은 그래프)
2. 방정식 "3" 선택 (V자)
3. V자의 꼭짓점(x=0)에 정확히 손가락 맞추기
4. 정밀한 손 제어 연습
```

---

## 🛠️ 문제 해결

### "캘리브레이션 데이터를 찾을 수 없습니다"
```bash
# 해결 방법
python examples/calibrate_cameras.py

# 체스보드를 양쪽 카메라에 보이도록 위치
# 스페이스바로 20장 촬영
# → data/stereo_calibration.pkl 생성 확인
```

### "손이 감지되지 않습니다"
```bash
# 원인 1: 카메라 시야
→ 양쪽 카메라에 손이 모두 보이는지 확인

# 원인 2: 조명
→ 밝은 조명 환경으로 변경

# 원인 3: 민감도
→ config.yaml에서 min_detection_confidence: 0.3으로 낮춤
```

### "그래프가 예상과 다르게 그려집니다"
```bash
# 좌표계 확인
1. z_offset 값 조정 (기본값: 400.0)
   → 그래프가 카메라에 너무 가까우면 값을 크게
   → 그래프가 카메라에 너무 멀면 값을 작게

2. 방정식 스케일 조정
   lambda x: (x**2) / 100  # 나누는 값을 변경
```

### "진동모터가 작동하지 않습니다"
```bash
# 하드웨어 확인
1. GPIO 핀 연결 확인 (18번 핀)
2. 전원 공급 확인
3. 진동모터 극성 확인

# 소프트웨어 확인
config.yaml:
  simulation_mode: false  # true면 실제 모터 작동 안 함
```

### "카메라를 열 수 없습니다"
```bash
# Windows에서 카메라 인덱스 확인
ls /dev/video*  # Linux
v4l2-ctl --list-devices  # Linux

# config.yaml 수정
camera:
  left_camera_index: 0  # 숫자 변경 시도
  right_camera_index: 1
```

---

## 📊 성능 최적화

### FPS 향상
```python
# 해상도 낮추기 (config.yaml)
camera:
  resolution:
    width: 320   # 640 → 320
    height: 240  # 480 → 240

# 그래프 점 개수 줄이기 (main.py)
virtual_graph.set_equation(eq_func, (x_min, x_max), num_points=50)  # 100 → 50
```

### 정확도 향상
```python
# 그래프 점 개수 늘리기
num_points=200  # 더 부드러운 곡선

# 캘리브레이션 재수행
# 더 많은 이미지로 캘리브레이션 (config.yaml)
stereo_calibration:
  num_calibration_images: 30  # 20 → 30
```

---

## 💡 응용 아이디어

### 교육용 활용
- 시각 장애인을 위한 수학 그래프 교육
- 함수의 형태를 촉각으로 학습
- 미분/적분 개념 체험 (기울기 변화 느끼기)

### 게임/엔터테인먼트
- 가상 미로 게임 (그래프 = 벽)
- 리듬 게임 (특정 타이밍에 그래프 터치)
- 3D 드로잉 앱 (손가락으로 공간에 그리기)

### 재활/치료
- 손 재활 훈련 (정밀한 움직임 연습)
- 공간 인지 능력 향상
- 촉각 피드백 기반 운동 치료

---

## 📝 라이센스 & 기여

이 프로젝트는 교육 및 연구 목적으로 개발되었습니다.

**기여 방법:**
1. 새로운 방정식 추가
2. 사용자 인터페이스 개선
3. 성능 최적화
4. 문서 개선

**문의:**
- GitHub Issues를 통해 버그 리포트 및 기능 제안 환영

---

## 🎉 즐거운 체험 되세요!

**팁:** 처음 사용 시 간단한 방정식(1번: 포물선)부터 시작하세요!
